<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>CIAT SOC APPLICATION</title>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
		<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Oxygen:300">
		
		<script src="https://code.highcharts.com/highcharts.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		
		<!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		
		
		<!-- Editable cell -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/css/bootstrap-editable.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
		
		<!-- Range Slider -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.0.5/rangeslider.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.0.5/rangeslider.min.js"></script>
		
		
		<script>
			var data;
			var options;
			var graphovershootchecked = false;
			var checkforgraphovershoot = false;
			var activity1tablecomputations = [];
			var activity1graphcomputations = [];
			var activity2tablecomputations = [];
			var activity2graphcomputations = [];
			var activity3tablecomputations = [];
			var activity3graphcomputations = [];
			var addindex = 0;
			var showcomputations = false;
			var clickedcell;
			var totalacreageglobal;
			var totalyearsglobal = 60; // default year
			var minslidervalue = 800;
			var maxslidervalue = 1000;
			var rateconsfactor = 998;
			var area_year_soc_seq_total = 0.0;
			var serialized_faovaluedict = {};
			var faolocalitytypedata = ["Agricultural", "Pasture"]; // same length as faovaluedict/ serialized_faovaluedict keys
			var filepath = "faodata.json";
			
			
			$(document).ready(function() {
				addtablerow(5);
				
				$('#tblactivity1').on('click', 'input[type="button"]', function(e){
				   $(this).closest('tr').remove();
				});
				
				// fetch FAO json data
				$.getJSON(filepath, {
					format: "json"
				})
				.done(function(data) {
					serialized_faovaluedict = data;
					var obj = serialized_faovaluedict;
					
					// locality
					$('#cmblocality').find('option').remove();
					$('#cmblocality').append($('<option>', {
						value: "",
						text : "[Select Locality]"
					}));
					for(var key in obj){
						if (obj.hasOwnProperty(key)){
							$('#cmblocality').append($('<option>', { 
								value: key,
								text : key //obj[key]
							}));
						}
					}
				})
				.fail(function(jqxhr, textStatus, error) {
					alert("Request Failed: " + textStatus + ", " + error);
					return;
				});
				
				$('#cmblocality').on('change', function() {
					if ($(this).val()) {
						$('#txtacreage').val(fetchacreage($(this).val()));
					} else {
						$('#txtacreage').val("");
					}
					
					if ($(this).val()) {
						$('#txtlocality').val($(this).val());
						$('#txtlocality').prop('readonly', true);
						$('#divlocality').css({"display": "none"});
					} else {
						$('#txtlocality').val("");
						$('#txtlocality').prop('readonly', false);
						$('#divlocality').css({"display": "inline-block"});
					}
				});
				
				// land use
				$('#cmblanduse').find('option').remove();
				$('#cmblanduse').append($('<option>', { 
					value: "",
					text : "[Select Land Use]"
				}));
				for(i = 0; i < faolocalitytypedata.length; i++){
					$('#cmblanduse').append($('<option>', { 
						value: i,
						text : faolocalitytypedata[i]
					}));
				}
				
				$('#cmblanduse').on('change', function() {
					if ($('#cmblocality').val() && $(this).val()) {
						$('#txtacreage').val(fetchacreage($('#cmblocality').val()));
					} else {
						$('#txtacreage').val("");
					}
					
					if ($(this).val()) {
						$('#txtlanduse').val($("#cmblanduse option:selected").text());
						$('#txtlanduse').prop('readonly', true);
						$('#divlanduse').css({"display": "none"});
					} else {
						$('#txtlanduse').val("");
						$('#txtlanduse').prop('readonly', false);
						$('#divlanduse').css({"display": "inline-block"});
					}
				});
				
				
				
				
				
			});
			
			
			function fetchacreage(selectdlocality) {
				var sellanduse = $("#cmblanduse option:selected").text();
				if (sellanduse) {
					var obj = serialized_faovaluedict;
					return obj[selectdlocality][sellanduse];
				
				} else {
					return "";
				}
			}
			
			
			function addtablerowclick() {
				// if input is numeric
				if (!$.isNumeric($('#txtaddrow').val())) {
					$('#txtaddrow').css({ "border": "solid 2px #FF0000" });
					return;
				}
				
				$('#txtaddrow').css({ "border": "solid 1px #dddddd" });
			
				addtablerow(parseInt($('#txtaddrow').val()));
			}
			
			
			function addtablerow(noofrows) {
				var thicknessval;
				var socstartval;
				var socendval;
				var bulkdensityval;
				
				for (i = 0; i < noofrows; i++) {
					switch(addindex) {
						case 0:
							thicknessval = 6;
							socstartval = 35;
							socendval = 45;
							bulkdensityval = 1.2;
							break;
						case 1:
							thicknessval = 22;
							socstartval = 30;
							socendval = 30;
							bulkdensityval = 1.25;
							break;
						case 2:
							thicknessval = 34;
							socstartval = 15;
							socendval = 20;
							bulkdensityval = 1.3;
							break;
						case 3:
							thicknessval = 40;
							socstartval = 10;
							socendval = 10;
							bulkdensityval = 1.35;
							break;
						case 4:
							thicknessval = 44;
							socstartval = 5;
							socendval = 5;
							bulkdensityval = 1.38;
							break;
						default:
							thicknessval = "??";
							socstartval = "??";
							socendval = "??";
							bulkdensityval = "??";
					}
					
					$('#tblactivity1').find('tbody').append('<tr>' +
							'<td class="editvalues1" contenteditable=true style="cursor:pointer;" data-title="Enter Thickness">' + thicknessval + '</td>' +
							'<td class="editvalues1" contenteditable=true style="cursor:pointer;" data-title="Enter SOC">' + socstartval + '</td>' +
							'<td class="editvalues1" contenteditable=true style="cursor:pointer;" data-title="Enter SOC">' + socendval + '</td>' +
							'<td class="editvalues1" contenteditable=true style="cursor:pointer;" data-title="Enter Bulk Density">' + bulkdensityval + '</td>' +
							'<td><input type="button" style="color:red;" value="X"/></td>' +
						'</tr>');
		
					addindex += 1;
				}
				
				$('#divactivity1table').css({"display": "block"});
				
				$('.editvalues1').editable({
					mode: "popup",
					validate: function(value) {
						if (!$.isNumeric($.trim(value))) {
							return "Enter numeric value";
						}
					}
				});
				$('.editvalues1').on('hidden', function (e, params) {
					displayactivityvalues();
				});
			}
			
			
			function removetablerow($row) {
				$(this).parent().parent().remove();
				if (addindex > 0) {
					addindex-=1;
				}
			}
			
			
			function checkgraphovershootchange() {
				if ($('#checkgraphovershoot').is(':checked')) {
					graphovershootchecked = true;
				} else {
					graphovershootchecked = false;
				}
				
				// compute graph values
				computeactivity2graphvalues();
			}
			
			
			function displayactivityvalues() {
				if (!$('#txtlocality').val()) {
					$('#txtlocality').css({ "border": "solid 2px #FF0000" });
					return;
				}
				$('#txtlocality').css({ "border": "solid 1px #dddddd" });
				
				if (!$('#txtlanduse').val()) {
					$('#txtlanduse').css({ "border": "solid 2px #FF0000" });
					return;
				}
				$('#txtlanduse').css({ "border": "solid 1px #dddddd" });
				
				if (!$.isNumeric($('#txtacreage').val())) {
					$('#txtacreage').css({ "border": "solid 2px #FF0000" });
					return;
				}
				$('#txtacreage').css({ "border": "solid 1px #dddddd" });
				totalacreageglobal = parseFloat($('#txtacreage').val());
				
				if ($('#checkcomps').is(':checked')) {
					showcomputations = true;
				} else {
					showcomputations = false;
				}
				
				if (tablevaluesvalid($("#tblactivity1")) == true) {
					$('#divactivity1computedtable').empty();
					$('#divactivity2computedtable').empty();
					$('#divactivity3computedtable').empty();
					
					$('#divactivity1computedtable').css({"display": "none"});
					$('#divactivity2computedtable').css({"display": "none"});
					$('#divactivity3computedtable').css({"display": "none"});
					
					$('#divactivity1graphtable').empty();
					$('#divactivity2graphtable').empty();
					$('#divactivity3graphtable').empty();
					
					$('#divactivity1graphtable').css({"display": "none"});
					$('#divactivity2graphtable').css({"display": "none"});
					$('#divactivity3graphtable').css({"display": "none"});
					
					$('#ct-chartactivity1').empty();
					$('#ct-chartactivity2').empty();
					$('#ct-chartactivity3').empty();
					
					$('#ct-chartactivity1').css({"display": "none"});
					$('#ct-chartactivity2').css({"display": "none"});
					$('#ct-chartactivity3').css({"display": "none"});
					
					$('#divsocsequence').empty();
					$('#divsocsequence').css({"display": "none"});
					
					displayactivityonevalues();
				}
			}
			
			
			function displayactivityonevalues() {
				$('#divactivity1computedtable').empty();
				
				// append computed values
				activity1tablecomputations = computeactivityonevalues();
				if (activity1tablecomputations) {
					// if display tables
					if (showcomputations == true) {
						$('#divactivity1computedtable').append('<p>Computed Values:</p>' +
						'<table id="tblactivity1computedvalues" class="table table-striped table-hover table-bordered table-condensed">');
						
						$('#tblactivity1computedvalues').append('<thead>' +
							'<th>Layer</th><th>Layer Thickness (cm)</th><th>Layer, top depth(cm)</th><th>Layer, bottom depth(cm)</th><th>Layer, mid depth(cm)</th><th>SOC conc. (g/kg) - START</th><th>SOC conc. (g/kg) - END</th><th>Delta SOC (g/kg)</th><th>Bulk density (g/cm3)</th><th>SOC-seq (Mg/ha/depth)</th>' +
						'</thead>' +
							
						'<tbody>' +
							
						'</tbody>');
					}
				
					// new div on the right
					$('#divsocsequence').append('<div><table id ="tblsocsequence" class="table table-striped table-hover table-bordered table-condensed"><p><h5>SOC Sequestration</h5></p></div>');
					$('#tblsocsequence').append('<thead><th>Layer</th><th>Thickness (cm)</th><th>SOC-Seq (Mg/ha/depth)</th></thead><tbody></tbody>');
					
					for (i = 0; i < activity1tablecomputations.length; i++) {
						var returnrows = activity1tablecomputations[i];
						$('#tblsocsequence').find('tbody').append('<tr><td style="color:#8c8c8c;">' + returnrows[0] + '</td><td style="color:#8c8c8c;">' + returnrows[1] + '</td><td style="color:#8c8c8c;">' + returnrows[returnrows.length - 1] + '</td></tr>');
					}
					
					$('#divsocsequence').css({ "display": "block" });
					
					// if display tables
					if (showcomputations == true) {
						for (i = 0; i < activity1tablecomputations.length; i++) {
							var returnrows = activity1tablecomputations[i];
							
							$('#tblactivity1computedvalues').find('tbody').append('<tr></tr>');
							
							for (j = 0; j < returnrows.length; j++) {
								$('#tblactivity1computedvalues tr:last').append('<td>' + returnrows[j] + '</td>');
							}
						}
						
						$('#divactivity1computedtable').css({ "display": "block" });
					}
					
					// create graph values (for second table)
					activity1graphcomputations = computeactivityonegraphvalues(activity1tablecomputations);
					var labelsdata = [];
					var linesmoothenedstart = [];
					var linesmoothenedend = [];
					var markerliststart = []; // holds values to display with marker
					var markerlistend = []; // holds values to display with marker
					
					if (activity1graphcomputations) {
						// if display tables
						if (showcomputations == true) {
							$('#divactivity1graphtable').append('<table id="tblactivity1graphvalues" class="table table-striped table-hover table-bordered table-condensed">');
								
								$('#tblactivity1graphvalues').append('<thead>' +
									'<th>Depth(cm)</th><th>Line, smoothened - START</th><th>Line, smoothened - END</th>' +
								'</thead>' +
									
								'<tbody>' +
									
								'</tbody>');
						}
						
						for (k = 0; k < activity1graphcomputations.length; k++) {
							var returnrows = activity1graphcomputations[k];
							
							// if display tables
							if (showcomputations == true) {
								var item = '<tr>';
								
								for (l = 0; l < returnrows.length; l++) {
									item += '<td>' + returnrows[l] + '</td>';
								}
								item += '</tr>';
								$('#tblactivity1graphvalues').find('tbody').append(item);
							}
							
							labelsdata.push(returnrows[0]);
							linesmoothenedstart.push(returnrows[1]);
							linesmoothenedend.push(returnrows[2]);
						}
						
						if (showcomputations == true) {
							$('#divactivity1graphtable').css({ "display": "block" });
						}
						
						
						// get marker values
						for (i = 1; i < activity1tablecomputations.length - 2; i++) {
							var returnrows = activity1tablecomputations[i];
							markerliststart.push(returnrows[5]);
							markerlistend.push(returnrows[6]);
						}
						
						// draw graph
						drawactivityonegraph(labelsdata, linesmoothenedstart, linesmoothenedend, markerliststart, markerlistend);
						
					} else {
						alert("No values for graph display.");
					}
					
				} else {
					alert("Some values not computed.");
				}
			}
			
			
			function computeactivityonevalues() {
				var layer = 0;
				var layerthickness = "";
				var topdepth = "";
				var bottomdepth = "";
				var middepth = 0;
				var socstart = 0;
				var socend = 0;
				var deltasoc = "";
				var bulkdensity = "";
				var socseq = "";
				var sumlayerthickness = 0.0;
				var sumbulkdensity = 0.0;
				var sumsocseq = 0.0;
				var lastrowlist = [];
				var activityonecomputedlist = [];
				var r = 0;
				
				checkforgraphovershoot = false;
				
				$('#tblactivity1 tbody').find('tr').each(function () {
					var rowlist = [];
					var selrow = $(this);
					
					if (r == 0){
						socstart = selrow.find('td').eq(1).html();
						socend = selrow.find('td').eq(2).html();
						rowlist = [layer, layerthickness, topdepth, bottomdepth, middepth, socstart, socend, deltasoc, bulkdensity, socseq];
						activityonecomputedlist.push(rowlist);
						
						rowlist = [];
						layer = r + 1;
						
						layerthickness = parseInt(selrow.find('td').eq(0).html());
						topdepth = 0;
						bottomdepth = layerthickness + topdepth;
						middepth = (topdepth + bottomdepth)/2;
						socstart = parseInt(selrow.find('td').eq(1).html());
						socend = parseInt(selrow.find('td').eq(2).html());
						deltasoc = (socend - socstart)
						bulkdensity = parseFloat(selrow.find('td').eq(3).html());
						
						// compute
						socseq = (parseFloat(selrow.find('td').eq(0).html()) * deltasoc * bulkdensity)/10.0;
						sumlayerthickness += parseInt(layerthickness);
						sumbulkdensity += parseFloat(layerthickness) * parseFloat(bulkdensity);
						sumsocseq += parseFloat(socseq);
						
						rowlist = [layer, layerthickness, topdepth, bottomdepth, middepth, socstart, socend, deltasoc, bulkdensity, socseq];
						activityonecomputedlist.push(rowlist);
						
					} else {
						layer = r + 1;
						layerthickness = parseInt(selrow.find('td').eq(0).html());
						topdepth = bottomdepth; // previous
						bottomdepth = layerthickness + topdepth;
						middepth = (topdepth + bottomdepth)/2;
						socstart = parseInt(selrow.find('td').eq(1).html());
						socend = parseInt(selrow.find('td').eq(2).html());
						deltasoc = (socend - socstart)
						bulkdensity = parseFloat(selrow.find('td').eq(3).html());
						
						// compute
						socseq = (parseFloat(selrow.find('td').eq(0).html()) * deltasoc * bulkdensity)/10.0;
						sumlayerthickness += parseInt(layerthickness);
						sumbulkdensity += parseFloat(layerthickness) * parseFloat(bulkdensity);
						sumsocseq += parseFloat(socseq);
						
						rowlist = [layer, layerthickness, topdepth, bottomdepth, middepth, socstart, socend, deltasoc, bulkdensity, socseq];
						activityonecomputedlist.push(rowlist);
					}
					
					r+=1;
					lastrowlist = rowlist;
					
					rowlist = [];
				});
				
				activityonecomputedlist.push(["Last", "", "", "", parseInt(lastrowlist[4]) + 5, lastrowlist[5], lastrowlist[6], "", "", ""]);
				activityonecomputedlist.push(["", "", "", "", "", "", "", "", sumbulkdensity/sumlayerthickness, sumsocseq]);
				
				return activityonecomputedlist;
			}
			
			
			function computeactivityonegraphvalues(graphlist) {
				var layerdepth_range = [];
				var socstart_range = [];
				var socend_range = [];
				var activityonecomputedgraphlist = [];
				var linesmoothenedstart = 0.0;
				var linesmoothenedend = 0.0;
				
				if (activity1tablecomputations) {
					for (i = 0; i < activity1tablecomputations.length - 1; i++) {
						layerdepth_range.push(parseFloat(activity1tablecomputations[i][4]));
						socstart_range.push(parseFloat(activity1tablecomputations[i][5]));
						socend_range.push(parseFloat(activity1tablecomputations[i][6]));
					}
					
					var highestdepth = parseFloat(graphlist[graphlist.length - 3][3]) + 5;
					
					for (depth = 0; depth < highestdepth; depth++) {
						linesmoothenedstart = cubic_spline(layerdepth_range, socstart_range, depth);
						linesmoothenedend = cubic_spline(layerdepth_range, socend_range, depth);
						
						rowlist = [depth, linesmoothenedstart, linesmoothenedend];
						activityonecomputedgraphlist.push(rowlist);
					}
				}
				
				return activityonecomputedgraphlist;
			}
			
			
			
			function drawactivityonegraph(labelsdata, linesmoothenedstart, linesmoothenedend, markerliststart, markerlistend) {
				var chart = new Highcharts.Chart({
					chart: {
						renderTo: 'ct-chartactivity1',
						type: 'line',
						inverted: true
					},
					credits: {
						enabled: false
					},
					title: {
						text: 'SOC Concentration',
						x: -20 //center
					},
					xAxis: {
						categories: labelsdata,
						allowDecimals: false,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1
					},
					yAxis: {
						title: {
							text: 'SOC (g/kg)'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						allowDecimals: false,
						opposite: true,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1
					},
					plotOptions: {
						series: {
							marker: {
								enabled: false
							}
						}
					},
					tooltip: {
						valueSuffix: 'g/kg'
					},
					legend: {
						layout: 'horizontal',
						align: 'center',
						verticalAlign: 'bottom',
						borderWidth: 0
					},
					series: [{
						name: 'START (g/kg)',
						data: linesmoothenedstart
						
					}, {
						name: 'END (g/kg)',
						data: linesmoothenedend
					}]
				});
				
				// update series 1 chart
				var seriesend = chart.series[1];
				if (seriesend.data.length) {
					var lastvalupdated;
					
					for (j = 0; j < seriesend.data.length; j++) {
						if ((markerlistend.indexOf(seriesend.data[j].y) >= 0) && (seriesend.data[j].y != lastvalupdated)) {
							seriesend.data[j].update({
								marker:{
									enabled: true,
									symbol: 'square',
									radius: 8,
									fillColor: 'white',
									lineColor: '#FF0000',
									lineWidth: 1,
									states: {
										allowPointSelect: true,
										hover: {
											fillColor: 'red',
											lineColor: 'red'                                	
										}
									}
								}
							});
							lastvalupdated = seriesend.data[j].y;
						}
					}
				}
				
				// update series 0 chart
				var seriesstart = chart.series[0];
				if (seriesstart.data.length) {
					var lastvalupdated;
					
					for (j = 0; j < seriesstart.data.length; j++) {
						if ((markerliststart.indexOf(seriesstart.data[j].y) >= 0) && (seriesstart.data[j].y != lastvalupdated)) {
							seriesstart.data[j].update({
								marker:{
									enabled: true,
									symbol: 'circle',
									radius: 8,
									fillColor: 'white',
									lineColor: '#000000',
									lineWidth: 1,
									states: {
										allowPointSelect: true,
										hover: {
											fillColor: '#000000',
											lineColor: '#000000'                                	
										}
									}
								}
							});
							lastvalupdated = seriesstart.data[j].y;
						}
					}
				}
				
				$('#ct-chartactivity1').css({ "display": "block" });
				$('#outerdiv').css({ "display": "block" });
				
				// activity 2 computations
				displayactivitytwovalues();
			}
			
			
			function displayactivitytwovalues() {
				$('#divactivity2computedtable').empty();
				activity2tablecomputations = [];
				
				var rowvalues = ["", "Year"];
				for (x = 1; x < $('#tblactivity1').find('tr').length; x++) {
					rowvalues.push("Layer " + x);
				}
				rowvalues.push("% Increase");
				
				activity2tablecomputations.push(rowvalues);
				
				var layerarray = [];
				var selrow;
				var layerrows = [];
				
				$('#tblactivity1 tbody').find('tr').each(function () {
					selrow = $(this);
					layerrows = [selrow.find('td').eq(1).html(), "", "", selrow.find('td').eq(2).html(), selrow.find('td').eq(3).html(), selrow.find('td').eq(0).html()];
					layerarray.push(layerrows);
				});
				
				rowvalues = ["START", 0];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][0]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues); 
				
				rowvalues = ["", ""];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][1]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues); 
				
				rowvalues = ["", ""];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][2]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues);
				
				rowvalues = ["END", totalyearsglobal];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][3]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues);
				
				rowvalues = ["BD (g/cm3)", ""];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][4]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues);
				
				rowvalues = ["Thickness (cm)", ""];
				for (i = 0; i < layerarray.length; i++) {
					rowvalues.push(layerarray[i][5]);
				}
				rowvalues.push("");
				activity2tablecomputations.push(rowvalues);
				
				// update values
				if (activity2tablecomputations.length == 7) {
					if (updateactivity2yearcomputations() == false) {
						alert("User input values invalid.");
						return;
					}
					if (updateactivity2layercomputations() == false) {
						alert("User input values invalid.");
						return;
					}
					
				} else {
					alert("Values failed to compute.");
					return;
				}
				
				// append computed values
				if (activity2tablecomputations) {
					for (i = 0; i < activity2tablecomputations.length; i++) {
						if (i == 0) {
							$('#divactivity2computedtable').append('<p><div style="float:left;"><h5>Computed Values</h5></div><div class="checkbox" style="float:right;"><input type="checkbox" id="checkgraphovershoot" onchange="checkgraphovershootchange()" value="Prevent Overshooting">Prevent Overshooting<br></div></p>' +
							'<table id="tblactivity2computedvalues" class="table table-striped table-hover table-bordered table-condensed">');
							
							if (graphovershootchecked == true) {
								$('#checkgraphovershoot').prop('checked', true);
							}
							
							var headeritem = '<thead>';
							for (j = 0; j < activity2tablecomputations[i].length; j++) {
								headeritem+='<th>' + activity2tablecomputations[i][j] + '</th>';
							}
							headeritem+='</thead>' + '<tbody>' + '</tbody>';
							
							$('#tblactivity2computedvalues').append(headeritem);
							
						} else {
							var rowitem = '<tr>';
							
							for (k = 0; k < activity2tablecomputations[i].length; k++) {
								if (((i == 2 || i == 3 || i == 4) && k == 1) || ((i == 2 || i == 3) && k == 2)) {
									rowitem += '<td class="editvalues2" contenteditable=true style="cursor:pointer;" data-title="Edit Value">' + activity2tablecomputations[i][k] + '</td>';
								} else {
									rowitem += '<td contenteditable=false style="color:#8c8c8c;">' + activity2tablecomputations[i][k] + '</td>';
								}
							}
							
							rowitem += '</tr>';
							$('#tblactivity2computedvalues').find('tbody').append(rowitem);
						}
					}
					
					$('.editvalues2').editable({
						mode: "popup",
						validate: function(value) {
							if (!$.isNumeric($.trim(value))) {
								return "Enter numeric value";
							}
						}
					});
					
					$('.editvalues2').on('hidden', function (e, params) {
						activity2tablevalueschanged(e.target);
					});
					
					$('#divactivity2computedtable').css({ "display": "block" });
					
					// compute graph values
					computeactivity2graphvalues();
					
				} else {
					alert("Some values not computed.");
				}
			}
			
			
			function updateactivity2yearcomputations() {
				if (!$.isNumeric(activity2tablecomputations[4][1])) {
					return false;

				} else {
					totalyearsglobal = parseInt(activity2tablecomputations[4][1]);
					activity2tablecomputations[2][1] = totalyearsglobal/3;
					activity2tablecomputations[3][1] = totalyearsglobal * 2/3;
					return true;
				}
			}
			
			function updateactivity2layercomputations() {
				activity2tablecomputations[2][2] = parseFloat(activity2tablecomputations[1][2]) + (parseFloat(activity2tablecomputations[4][2]) - parseFloat(activity2tablecomputations[1][2])) * 0.6;
				activity2tablecomputations[3][2] = parseFloat(activity2tablecomputations[1][2]) + (parseFloat(activity2tablecomputations[4][2]) - parseFloat(activity2tablecomputations[1][2])) * 0.9;
				
				activity2tablecomputations[2][activity2tablecomputations[0].length - 1] = (parseFloat(activity2tablecomputations[2][2]) - parseFloat(activity2tablecomputations[1][2]))/(parseFloat(activity2tablecomputations[4][2]) - parseFloat(activity2tablecomputations[1][2])) * 100.0;
				activity2tablecomputations[3][activity2tablecomputations[0].length - 1] = (parseFloat(activity2tablecomputations[3][2]) - parseFloat(activity2tablecomputations[1][2]))/(parseFloat(activity2tablecomputations[4][2]) - parseFloat(activity2tablecomputations[1][2])) * 100.0;
				
				for (i = 3; i < activity2tablecomputations[0].length - 1; i++) {
					activity2tablecomputations[2][i] = parseFloat(activity2tablecomputations[1][i]) + (parseFloat(activity2tablecomputations[2][activity2tablecomputations[0].length - 1])/100.0) * (parseFloat(activity2tablecomputations[4][i]) - parseFloat(activity2tablecomputations[1][i]));
					activity2tablecomputations[3][i] = parseFloat(activity2tablecomputations[1][i]) + (parseFloat(activity2tablecomputations[3][activity2tablecomputations[0].length - 1])/100.0) * (parseFloat(activity2tablecomputations[4][i]) - parseFloat(activity2tablecomputations[1][i]));
				}
				
				return true;
			}
			
			
			function computeactivity2graphvalues() {
				checkforgraphovershoot = true;
				$('#divactivity2graphtable').empty();
				activity2graphcomputations = [];
				totalyearsglobal = parseInt(activity2tablecomputations[4][1]);
				var rowvalues = ["Year"];
				
				for (i = 2; i < activity2tablecomputations[0].length - 1; i++) {
					rowvalues.push(activity2tablecomputations[0][i]);
				}
				
				for (i = 2; i < activity2tablecomputations[0].length - 1; i++) {
					rowvalues.push(activity2tablecomputations[0][i]);
				}
				rowvalues.push("All Layers");
				activity2graphcomputations.push(rowvalues);
				
				var yearrange = [parseFloat(activity2tablecomputations[1][1]), parseFloat(activity2tablecomputations[2][1]), parseFloat(activity2tablecomputations[3][1]), parseFloat(activity2tablecomputations[4][1])];
				
				for (i = 0; i <= totalyearsglobal; i++) {
					rowvalues = [i];
					var colval;
					
					for (j = 2; j < activity2tablecomputations[0].length - 1; j++) {	
						var layerrange = [parseFloat(activity2tablecomputations[1][j]), parseFloat(activity2tablecomputations[2][j]), parseFloat(activity2tablecomputations[3][j]), parseFloat(activity2tablecomputations[4][j])];
						colval = cubic_spline(yearrange, layerrange, i);
						rowvalues.push(colval);
					}
					
					if (i == 0) {
						for (j = 2; j < activity2tablecomputations[0].length - 1; j++) {
							rowvalues.push("");
						}
						rowvalues.push("");
						
					} else {
						var colsum = 0.0;
						for (j = 2; j < activity2tablecomputations[0].length - 1; j++) {
							colval = SOC_Konv((parseFloat(rowvalues[j-1]) - parseFloat(activity2graphcomputations[activity2graphcomputations.length - 1][j-1]))/10.0, parseFloat(activity2tablecomputations[5][j]), parseFloat(activity2tablecomputations[6][j]));
							rowvalues.push(colval);
							colsum += colval;
						}
						rowvalues.push(colsum);
					}
					
					activity2graphcomputations.push(rowvalues);
				}
				
				
				if (showcomputations == true) {
					for (i = 0; i < activity2graphcomputations.length; i++) {
						if (i == 0) {
							$('#divactivity2graphtable').append('<p>Computed Graph Values:</p>' +
							'<table id="tblactivity2graphvalues" class="table table-striped table-hover table-bordered table-condensed">');
							
							var headeritem = '<thead>';
							for (j = 0; j < activity2graphcomputations[i].length; j++) {
								headeritem+='<th>' + activity2graphcomputations[i][j] + '</th>';
							}
							headeritem+='</thead>' + '<tbody>' + '</tbody>';
							
							$('#tblactivity2graphvalues').append(headeritem);
							
						} else {
							var rowitem = '<tr>';
							
							for (k = 0; k < activity2graphcomputations[i].length; k++) {
								rowitem += '<td>' + activity2graphcomputations[i][k] + '</td>';
							}
							
							rowitem += '</tr>';
							$('#tblactivity2graphvalues').find('tbody').append(rowitem);
						}
					
						$('#divactivity2graphtable').css({ "display": "block" });
					}
				}
				
				var yearslabel = [];
				var soclayer1values = [];
				var socseqlayer1values = [];
				var markerlistsock = [];
				
				for (n = 1; n < activity2graphcomputations.length; n++) {
					yearslabel.push(activity2graphcomputations[n][0]);
					soclayer1values.push(activity2graphcomputations[n][1]);
					
					if (n > 1) {
						socseqlayer1values.push(activity2graphcomputations[n][activity2graphcomputations[0].length - 1]);
					}
				}
				
				for (j = 0; j < 4; j++) {
					markerlistsock.push(activity2tablecomputations[j+1][2]);
				}
				
				// draw graph
				drawactivitytwograph(yearslabel, soclayer1values, socseqlayer1values, markerlistsock);
			}
			
			
			function drawactivitytwograph(yearslabel, soclayer1values, socseqlayer1values, markerlistsock) {
				var chart = new Highcharts.Chart({
					chart: {
						renderTo: 'ct-chartactivity2',
						type: 'line'
					},
					credits: {
						enabled: false
					},
					title: {
						text: 'SOC Sequestration Over Time',
						x: -20 //center
					},
					xAxis: {
						categories: yearslabel,
						//allowDecimals: false,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1
					},
					yAxis: [{
						title: {
							text: 'SOC (g/kg)'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						allowDecimals: false,
						opposite: false,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1,
						min: 0
					},{
						title: {
							text: 'SOC Seq. (t/ha)'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						allowDecimals: true,
						opposite: true,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1,
						min: 0
					}],
					plotOptions: {
						series: {
							marker: {
								enabled: false
							}
						}
					},
					tooltip: {
						valueSuffix: 'g/kg'
					},
					legend: {
						layout: 'horizontal',
						align: 'center',
						verticalAlign: 'bottom',
						borderWidth: 0
					},
					series: [{
						name: 'SOC (g/kg)',
						data: soclayer1values,
						yAxis: 0
					},{
						name: 'SOC Seq. (t/ha))',
						data: socseqlayer1values,
						yAxis: 1
					}]
				});
				
				// update series 0 chart
				var seriessock = chart.series[0];
				if (seriessock.data.length) {
					var lastvalupdated;
					
					for (j = 0; j < seriessock.data.length; j++) {
						if ((markerlistsock.indexOf(seriessock.data[j].y) >= 0) && (seriessock.data[j].y != lastvalupdated)) {
							seriessock.data[j].update({
								marker:{
									enabled: true,
									symbol: 'circle',
									radius: 8,
									fillColor: 'white',
									lineColor: '#FF0000',
									lineWidth: 1,
									states: {
										allowPointSelect: true,
										hover: {
											fillColor: 'red',
											lineColor: 'red'                                	
										}
									}
								}
							});
							lastvalupdated = seriessock.data[j].y;
						}
					}
				}
				
				$('#ct-chartactivity2').css({ "display": "block" });
				$('#outerdiv').css({ "display": "block" });
				
				// activity 3 computations
				displayactivitythreevalues();
			}
			
			
			function displayactivitythreevalues() {
				$('#divactivity3computedtable').empty();
				activity3tablecomputations = [];
				
				var targetedarea = totalacreageglobal;
				var socseq = parseFloat(activity1tablecomputations[activity1tablecomputations.length - 1][9]);
				totalyearsglobal = parseFloat(activity2tablecomputations[4][1]);
				var rowvalues = [];
				
				$('#divactivity3computedtable').append('<p>SOC-sequestration over time</p>' +
					'<table id="tblactivity3computedvaluesA" class="table table-striped table-hover table-bordered table-condensed"><thead><th>Item</th><th>Value</th></thead><tbody></tbody>');
				
				rowvalues = ["Total targeted area (Mha)", targetedarea];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesA').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				rowvalues = ["SOC seq. (t/ha)", socseq];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesA').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				//if all land is brought under swquestration
				$('#divactivity3computedtable').append('<p>If all land is brought under swquestration</p>' +
					'<table id="tblactivity3computedvaluesB" class="table table-striped table-hover table-bordered table-condensed"><thead><th>Item</th><th>Value</th></thead><tbody></tbody>');
				
				rowvalues = ["SOC-sequestration total (t)", targetedarea * socseq * 1000000];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesB').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				rowvalues = ["SOC-sequestration total (Mt)", targetedarea * socseq];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesB').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				// Increase of hectares under a SOC seq. scheme over time
				$('#divactivity3computedtable').append('<div id="divactivity3computedvaluesC" style="display: inline-block; vertical-align:top; width:80%;"><p>If all land is brought under swquestration</p>' +
					'<table id="tblactivity3computedvaluesC" class="table table-striped table-hover table-bordered table-condensed"><thead><th>Item</th><th>Value</th></thead><tbody></tbody></div>');
				
				rowvalues = ["rate const", rateconsfactor/1000];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesC').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				rowvalues = ["Y_zero", 1/totalyearsglobal * 100];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesC').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				rowvalues = ["Total Years", totalyearsglobal];
				activity3tablecomputations.push(rowvalues);
				$('#tblactivity3computedvaluesC').find('tbody').append('<tr><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][0] + '</td><td style="color:#8c8c8c;">' + activity3tablecomputations[activity3tablecomputations.length - 1][1] + '</td></tr>');
				
				$('#divactivity3computedtable').append('<div id="divrangeslider" style="display: inline-block; vertical-align:top; width: 20%; text-align: right; padding-left:20px;"><input id="range_slider" type="range" min=' + minslidervalue + ' max=' + maxslidervalue + ' step="1" value=' + rateconsfactor + ' data-orientation="vertical"><output></output></div>');
				
				var $element = $('input[type="range"]');
				var $output = $('output');
				
				$element
				  .rangeslider({
					polyfill: false,
					onInit: function() {
					  updateOutput($output[0], this.value);
					},
					onSlideEnd: function(position, value) {
						updateactivity3graphvalues(value);
					}
				  })
				  .on('input', function() {
					updateOutput($output[0], this.value);
				  });
				  
				$('#divactivity3computedtable').css({ "display": "block" });
				$('#outerdiv').css({ "display": "block" });
				 
				// compute graph values
				computeactivity3graphvalues();
			}
			
			
			function updateactivity3graphvalues(slidervalue) {
				activity3tablecomputations[4][1] = parseFloat(slidervalue)/1000;
				
				var htable = document.getElementById('tblactivity3computedvaluesC');
				var hrows = htable.rows;
				
				hrows[1].cells[1].innerHTML = parseFloat(slidervalue)/1000;
				rateconsfactor = slidervalue;
				computeactivity3graphvalues();
			}
			
			
			function updateOutput(el, val) {
				el.textContent = val;
			}
			
			
			function computeactivity3graphvalues() {
				checkforgraphovershoot = false;
				$('#divactivity3graphtable').empty();
				activity3graphcomputations = [];
				var rowvalues = [];
				
				rowvalues = ["Year", "Area under Seq. - Added", "Area under Seq. - Total", "SOC-Seq (Mt/yr)"];
				activity3graphcomputations.push(rowvalues);
				
				totalyearsglobal = activity3tablecomputations[activity3tablecomputations.length - 1][1];
				var y_zero = activity3tablecomputations[activity3tablecomputations.length - 2][1];
				var rate_const = activity3tablecomputations[activity3tablecomputations.length - 3][1];
				var targetarea = activity3tablecomputations[0][1];
				var activity1bulkdensityavg = activity1tablecomputations[activity1tablecomputations.length - 1][8];
				var activity1layerdepth = activity1tablecomputations[activity1tablecomputations.length - 3][3];
				
				var exp_decay;
				var exp_decay_total = 0.0;
				var area_year_soc_seq = 0.0;
				var activity2yearrange = [];
				var activity2annualsocseq = [];
				area_year_soc_seq_total = 0.0
				
				for (i = 1; i < activity2graphcomputations.length; i++) {
					activity2yearrange.push(activity2graphcomputations[i][0]);
					activity2annualsocseq.push(activity2graphcomputations[i][activity2graphcomputations[0].length - 1]);
				}
				
				var yearslabel = [];
				var exp_decay_list = [];
				var area_year_soc_seq_list = [];
				
				for (i = 0; i <= totalyearsglobal; i++) {
					if (i == 0) {
						yearslabel.push(i);
						exp_decay_list.push("");
						area_year_soc_seq_list.push("");
						rowvalues = [0, "", "", ""];
						
					} else {
						//alert(totalyearsglobal + ", " + y_zero + ", " + rate_const + ", " +  i + ", " + activity2yearrange + ", " + activity2annualsocseq + ", " + activity1bulkdensityavg + ", " + activity1layerdepth + ", " + targetarea);
						exp_decay = ExpDecay(y_zero, i - 1, rate_const);
						exp_decay_total += exp_decay;
						area_year_soc_seq = Area_Year_SOC_Seq_NEW(totalyearsglobal, y_zero, rate_const, i, activity2yearrange, activity2annualsocseq, activity1bulkdensityavg, activity1layerdepth, targetarea);
						
						yearslabel.push(i);
						exp_decay_list.push(exp_decay_total);
						area_year_soc_seq_list.push(area_year_soc_seq);
						
						rowvalues = [i, exp_decay, exp_decay_total, area_year_soc_seq];
					}
					
					activity3graphcomputations.push(rowvalues);
					area_year_soc_seq_total += area_year_soc_seq;
				}
				
				if (showcomputations == true) {
					for (i = 0; i < activity3graphcomputations.length; i++) {
						if (i == 0) {
							$('#divactivity3graphtable').append('<p>Computed Graph Values:</p>' +
							'<table id="tblactivity3graphvalues" class="table table-striped table-hover table-bordered table-condensed">');
							
							var headeritem = '<thead>';
							for (j = 0; j < activity3graphcomputations[i].length; j++) {
								headeritem+='<th>' + activity3graphcomputations[i][j] + '</th>';
							}
							headeritem+='</thead>' + '<tbody>' + '</tbody>';
							
							$('#tblactivity3graphvalues').append(headeritem);
							
						} else {
							var rowitem = '<tr>';
							
							for (k = 0; k < activity3graphcomputations[i].length; k++) {
								rowitem += '<td>' + activity3graphcomputations[i][k] + '</td>';
							}
							
							rowitem += '</tr>';
							$('#tblactivity3graphvalues').find('tbody').append(rowitem);
						}
						
						$('#divactivity3graphtable').css({ "display": "block" });
					}
				}
				
				// draw graph
				drawactivitythreegraph(yearslabel, exp_decay_list, area_year_soc_seq_list);
			}
			
			
			function drawactivitythreegraph(yearslabel, exp_decay_list, area_year_soc_seq_list) {
				var chart = new Highcharts.Chart({
					chart: {
						renderTo: 'ct-chartactivity3',
						type: 'line'
					},
					credits: {
						enabled: false
					},
					title: {
						text: 'SOC Sequestration Over Time',
						x: -20 //center
					},
					xAxis: {
						categories: yearslabel,
						//allowDecimals: false,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1
					},
					yAxis: [{
						title: {
							text: '% of Total Area'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						allowDecimals: false,
						opposite: false,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1,
						min: 0
					},{
						title: {
							text: 'SOC Seq. (Mt/yr)'
						},
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}],
						allowDecimals: true,
						opposite: true,
						gridLineColor: '#D8D8D8',
						gridLineWidth: 1,
						min: 0
					}],
					plotOptions: {
						series: {
							marker: {
								enabled: true
							}
						}
					},
					tooltip: {
						valueSuffix: 'Mt/yr'
					},
					legend: {
						layout: 'horizontal',
						align: 'center',
						verticalAlign: 'bottom',
						borderWidth: 0
					},
					series: [{
						name: '% Total Area',
						data: exp_decay_list,
						yAxis: 0
					},{
						name: 'SOC Seq. (Mt/yr)',
						data: area_year_soc_seq_list,
						yAxis: 1
					}]
				});
				
				$('#ct-chartactivity3').css({ "display": "block" });
				$('#outerdiv').css({ "display": "block" });
				
				// final table computations
				displayfinaltablevalues();
			}
			
			
			function displayfinaltablevalues() {
				// update or insert new record
				checkforgraphovershoot = false;
				var selrow;
				var edittable = document.getElementById('tbltotalsocsequestration');
				for (i = 0; i < edittable.rows.length; i++) {
					if (edittable.rows[i].cells[0].innerHTML.toUpperCase() == $('#txtlocality').val().toUpperCase() && edittable.rows[i].cells[1].innerHTML.toUpperCase() == $("#cmblanduse option:selected").text().toUpperCase()) {
						selrow = edittable.rows[i];
					} 
				}
				
				if (selrow) {
					// update
					selrow.cells[2].innerHTML = totalyearsglobal;
					selrow.cells[3].innerHTML = area_year_soc_seq_total;
					
				} else {
					// insert
					$('#tbltotalsocsequestration').find('tbody').append('<tr>' +
							'<td style="color:#8c8c8c;">' + $('#txtlocality').val() + '</td>' +
							'<td style="color:#8c8c8c;">' + $("#txtlanduse").val() + '</td>' +
							'<td style="color:#8c8c8c;">' + totalyearsglobal + '</td>' +
							'<td style="color:#8c8c8c;">' + area_year_soc_seq_total + '</td>' +
						'</tr>');
				}
				
				// total
				var cnt = 0;
				var totalsocseq = 0.0;
				var alllanduse;
				edittable = document.getElementById('tbltotalsocsequestration');
				for (i = 0; i < edittable.rows.length; i++) {
					if (edittable.rows[i].cells[0].innerHTML.toUpperCase() == $('#txtlocality').val().toUpperCase() && edittable.rows[i].cells[1].innerHTML.indexOf(",") == -1) {
						totalsocseq += parseFloat(edittable.rows[i].cells[3].innerHTML);
						if (!alllanduse) {
							alllanduse = edittable.rows[i].cells[1].innerHTML;
						} else {
							alllanduse = alllanduse + ", " + edittable.rows[i].cells[1].innerHTML;
						}
						cnt+=1;
					}
				}
				
				if (cnt > 1) {
					selrow = "";
					edittable = document.getElementById('tbltotalsocsequestration');
					for (i = 0; i < edittable.rows.length; i++) {
						if (edittable.rows[i].cells[0].innerHTML.toUpperCase() == $('#txtlocality').val().toUpperCase() && edittable.rows[i].cells[1].innerHTML == alllanduse) {
							selrow = edittable.rows[i];
						}
					}
					
					if (selrow) {
						selrow.cells[3].innerHTML = totalsocseq;
					
					} else {
						// insert
						$('#tbltotalsocsequestration').find('tbody').append('<tr>' +
							'<td>' + $('#txtlocality').val() + '</td>' +
							'<td>' + alllanduse + '</td>' +
							'<td>' + totalyearsglobal + '</td>' +
							'<td>' + totalsocseq + '</td>' +
						'</tr>');
					}
				}
				
				$('#divtotalsocsequestration').css({ "display": "block" });
				$('#outerdiv').css({ "display": "block" });
				
				$('.panel-collapse').collapse('show');
				
				$('#ct-chartactivity1').highcharts().reflow();
				$('#ct-chartactivity2').highcharts().reflow();
				$('#ct-chartactivity3').highcharts().reflow();
			}
			
			
			function activity2tablevalueschanged($cell) {
				activity2tablecomputations = [];
				
				// check if cells are numeric
				if (!$.isNumeric(cleaninnerhtml($cell.innerHTML))) {
					$cell.style.borderColor = "#FF0000";
					$cell.style.borderWidth = "1.5px";
					return;
					
				} else {
					$cell.style.borderColor = "#dddddd";
					$cell.style.borderWidth = "1px";
				}
				
				var htable = document.getElementById('tblactivity2computedvalues');
				var hrows = htable.rows;
				
				// if year numeric and changed
				if ($cell.cellIndex == 1 && $cell.parentNode.rowIndex == 4) {
					totalyearsglobal = parseInt(hrows[4].cells[1].innerHTML);
					hrows[2].cells[1].innerHTML = totalyearsglobal/3;
					hrows[3].cells[1].innerHTML = totalyearsglobal * 2/3;
				}
				
				// check values
				if ((parseFloat(cleaninnerhtml(hrows[2].cells[1].innerHTML)) >= parseFloat(cleaninnerhtml(hrows[3].cells[1].innerHTML))) || (parseFloat(cleaninnerhtml(hrows[2].cells[2].innerHTML)) >= parseFloat(cleaninnerhtml(hrows[3].cells[2].innerHTML))) || (parseFloat(cleaninnerhtml(hrows[3].cells[1].innerHTML)) >= parseFloat(cleaninnerhtml(hrows[4].cells[1].innerHTML))) || (parseFloat(cleaninnerhtml(hrows[3].cells[2].innerHTML)) > parseFloat(cleaninnerhtml(hrows[4].cells[2].innerHTML)))) {
					$cell.style.borderColor = "#FF0000";
					$cell.style.borderWidth = "1.5px";
					return;
					
				} else {
					$cell.style.borderColor = "#dddddd";
					$cell.style.borderWidth = "1px";
				}
				
				// compute layer 1 values
				hrows[2].cells[hrows[0].cells.length - 1].innerHTML = (parseFloat(cleaninnerhtml(hrows[2].cells[2].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[2].innerHTML)))/(parseFloat(cleaninnerhtml(hrows[4].cells[2].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[2].innerHTML))) * 100.0;
				hrows[3].cells[hrows[0].cells.length - 1].innerHTML = (parseFloat(cleaninnerhtml(hrows[3].cells[2].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[2].innerHTML)))/(parseFloat(cleaninnerhtml(hrows[4].cells[2].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[2].innerHTML))) * 100.0;
				
				// compute other values
				for (i = 3; i < hrows[0].cells.length - 1; i++) {
					hrows[2].cells[i].innerHTML = parseFloat(cleaninnerhtml(hrows[1].cells[i].innerHTML)) + (parseFloat(cleaninnerhtml(hrows[2].cells[hrows[0].cells.length - 1].innerHTML))/100.0) * (parseFloat(cleaninnerhtml(hrows[4].cells[i].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[i].innerHTML)));
					hrows[3].cells[i].innerHTML = parseFloat(cleaninnerhtml(hrows[1].cells[i].innerHTML)) + (parseFloat(cleaninnerhtml(hrows[3].cells[hrows[0].cells.length - 1].innerHTML))/100.0) * (parseFloat(cleaninnerhtml(hrows[4].cells[i].innerHTML)) - parseFloat(cleaninnerhtml(hrows[1].cells[i].innerHTML)));
				}
				
				for (i = 0; i < hrows.length; i++) {
					var colvals = [];
					for (j = 0; j < hrows[i].cells.length; j++) {
						colvals.push(cleaninnerhtml(hrows[i].cells[j].innerHTML));
					}
					activity2tablecomputations.push(colvals);
				}
				
				// compute graph values
				computeactivity2graphvalues();
			}
			
			
			function tablevaluesvalid(inputtable) {
				var isvalid = true;
				
				if (inputtable.find('tr').length <= 1) {
					isvalid = false;
					return isvalid;
				}
				
				inputtable.find('tr').each(function () {
					$(this).find('td').each(function () {
						if (!$(this).is(':last-child')) {
							if (!$.isNumeric($(this).text())) {
								isvalid = false;
								$(this).css ({
									"border": "solid 2px #FF0000"
								});
							} else {
								$(this).css ({
									"border": "solid 1px #dddddd"
								});
							}
						}
					});
				});
				
				return isvalid;
			}
			
			
			function cleaninnerhtml(cellvalue) {
				return cellvalue.replace(/<br>/g, '');
			}
			
			
			function displayabout() {
				if ($('#divintroduction').css('display') == 'none') {
				   $('#divintroduction').css({ "display": "block" });
				} else {
					$('#divintroduction').css({ "display": "none" });
				}
			}
			
			
			// From VBA codes
			function SOC_Konv(SOC_percent, BD, Layer_Thickness_cm) { // SOC_percent As Double, BD As Double, Layer_Thickness_cm As Double
				// BD in g cm-3, Layer thickness in cm, SOC as soil organc _carbon_ in percent
				return(SOC_percent * BD * Layer_Thickness_cm); //Result is Mg ha-1 depth-1; depth in cm
			}
			
			
			/*********************  Cubic_Spline by SRS1 Software **************** Version 1.01*/
			function cubic_spline(Input_x_range, Input_y_range, X_for_which_2find_Y) { // Input_x_range As Range, Input_y_range As Range, X_for_which_2find_Y As Double
				/*Purposecubic_spline:   Given a data set consisting of a list of x values
						   and y values, this function will smoothly interpolate
						   a resulting output (y) value from a given input (x) value */

				// This counts how many points are in "input" and "output" set of data
				var input_count; // Integer
				var output_count; // Integer

				var input_count = Input_x_range.length; // row count
				var output_count = Input_y_range.length; // row count
				
				// Next check to be sure that "input" # points = "output" # points
				if (input_count != output_count) {
					return "Something's messed up!  The number of indices number of input x and y ranges don't match!";
				}
				
				var xin = new Array(input_count); // ReDim xin(input_count) As Single
				var yin = new Array(input_count); // ReDim yin(input_count) As Single
				//var c; // Integer
				
				for (c = 0; c < input_count; c++) {
					xin[c] = Input_x_range[c];
					yin[c] = Input_y_range[c];
				}
				
				// values are populated
				var n; // Integer 'n=input_count
				var i, K; // Integer 'these are loop counting integers
				var p, qn, sig, un; // Single
				var U = new Array(input_count - 1); // ReDim U(input_count - 1) As Single
				var yt = new Array(input_count); //ReDim yt(input_count) As Single 'these are the 2nd deriv values
				
				n = input_count;
				yt[0] = 0;
				U[0] = 0;
				
				for (i = 1; i < n - 1; i++) {
					sig = (xin[i] - xin[i - 1]) / (xin[i + 1] - xin[i - 1]);
					p = sig * yt[i - 1] + 2;
					yt[i] = (sig - 1) / p;
					U[i] = (yin[i + 1] - yin[i]) / (xin[i + 1] - xin[i]) - (yin[i] - yin[i - 1]) / (xin[i] - xin[i - 1]);
					U[i] = (6 * U[i] / (xin[i + 1] - xin[i - 1]) - sig * U[i - 1]) / p;
				}
				
				qn = 0;
				un = 0;
				
				yt[n - 1] = (un - qn * U[n - 2]) / (qn * yt[n - 2] + 1);
				
				for (K = n - 2; K >= 1; K--) {
					yt[K] = yt[K] * yt[K + 1] + U[K];
				}
				
				// now eval spline at one point
				var klo, khi; // Integer
				var h, b, a; // Single
				
				// first find correct interval
				klo = 1;
				khi = n - 1;
				
				do {
					K = khi - klo;
					
					if (xin[K] > X_for_which_2find_Y) {
						khi = K;
					} else {
						klo = K;
					}
					
					K = khi - klo;
				}
				while (K > 1);
				
				//alert(X_for_which_2find_Y + ", " + khi + ", " + klo);
				//// RS added - preventing negative or possitive values in-between two y-values equal zero!
				//if (yin[khi] == 0 && yin[klo] == 0) {
				//	return 0;
				//}
				
				// RS added - prevent cubic spline from 'overshooting'
				if (checkforgraphovershoot == true && graphovershootchecked == true) {
					if (yin[khi] == yin[klo] && khi > input_count - 2) {
						return yin[khi];
					}
					//End added
				}
				
				var Y; // Double
				
				// ********* check if multiplication should be float
				h = xin[khi] - xin[klo];
				a = (xin[khi] - X_for_which_2find_Y) / h;
				b = (X_for_which_2find_Y - xin[klo]) / h;
				
				//alert("X_for_which_2find_Y: " + X_for_which_2find_Y + " h: " + h + " a, " + a + " b, " + b);
				
				Y = a * yin[klo] + b * yin[khi] + ((Math.pow(a, 3) - a) * yt[klo] + (Math.pow(b, 3) - b) * yt[khi]) * (Math.pow(h, 2)) / 6;
				return Y;
			}
			
			
			// get exponential
			function ExpDecay(Y_t0, Jahr, rate_const) { // Y_t0 As Double, Jahr As Double, rate_const As Double
				return Y_t0 * (Math.exp(Math.log(rate_const) * Jahr));
			}
			
			
			function Area_Year_SOC_Seq_NEW(Jahre, Area_Time0, Area_rate_const, x, CubicSpline_X_range, CubicSpline_Y_range, BD, SoilDepth, Total_Area) { // Jahre As Integer, Area_Time0 As Double, Area_rate_const As Double, x As Double, CubicSpline_X_range As Range, CubicSpline_Y_range As Range, BD As Double, SoilDepth As Double, Total_Area As Double
				
				/*
				Jahre is the number of years for which each year additional area (following the exponential decay function)
				is added to sequestration campain
				x is the sequestration year
				*/
				
				var returnvalue = 0.0;
				var Area_Exp_Decay = new Array(); // length = 100 Double
				var SOC_Seq_Rate = new Array(); // length = 100 Double
				//var AreaYear = 0; // Integer
				//var SeqYear = 0; // Integer
				var Area_Seq_Year = new Array(); // length = 100 Double
				
				for (AreaYear = Jahre; AreaYear >= 1; AreaYear--) {
					Area_Exp_Decay[AreaYear] = ExpDecay(Area_Time0, AreaYear - 1, Area_rate_const);
				}
				
				for (SeqYear = x; SeqYear >= 1; SeqYear--) {
					SOC_Seq_Rate[SeqYear] = cubic_spline(CubicSpline_X_range, CubicSpline_Y_range, SeqYear);
				}
				
				//alert(x + " SOC_Seq_Rate " + SOC_Seq_Rate);
				
				SeqYear = x;
				
				for (AreaYear = 1; AreaYear <= Jahre; AreaYear++) {
					Area_Seq_Year[AreaYear] = SOC_Seq_Rate[SeqYear] * Area_Exp_Decay[AreaYear] * Total_Area;
					//Area_Year_SOC_Seq_NEW = Area_Year_SOC_Seq_NEW + Area_Seq_Year(AreaYear)
					//alert(AreaYear + ", " + Area_Seq_Year[AreaYear]);
					returnvalue += Area_Seq_Year[AreaYear];
					SeqYear -= 1;
					if (SeqYear < 1) {
						break;
					}
				}
				//alert(returnvalue);
				return returnvalue;
			}
			
			
			function Four_Param_Sigmoid(x, a, b, x0, Y0) { // x As Double, a As Double, b As Double, x0 As Double, Y0 As Double  
				return Y0 + a / (1 + Math.exp(-(x - x0) / b));
			}
			
			
			function FourSigm_a(x, b, x0, Y0, SOCx) { // x As Double, b As Double, x0 As Double, Y0 As Double, SOCx As Double
				return (SOCx - Y0) * (1 + Math.exp((x0 - x) / b));
			}
			
			
			function Annual_SOC_Seq_Rate(x, x_minus_1, a, b, x0, Y0, BD, SoilDepth) { // x As Double, x_minus_1 As Double, a As Double, b As Double, x0 As Double, Y0 As Double, BD As Double, SoilDepth As Double
				/*
				calculated the annual Soil Organic Carbon sequestration amount in Mg/ha/SoilDepth
				for the given increase in %-SOC based on a four-parameter sigmoid function
				Soil depth in cm
				BD in g/cm3
				*/
				
				var SOC0; // Double
				var SOC1; // Double
				var delta_SOC; // Double
				
				SOC0 = Four_Param_Sigmoid(x_minus_1, a, b, x0, Y0); // SOC-% last year
				SOC1 = Four_Param_Sigmoid(x, a, b, x0, Y0); // SOC-% current year
				delta_SOC = SOC1 - SOC0;
				
				return SOC_Konv(delta_SOC, BD, SoilDepth);
			}
			
			
			
		</script>
		
		<style type="text/css">
			

			.div-outer {
				width: 100%;
				overflow: auto;
				padding: 5px;
				display: none;
			}
			
			.div-compute-table {
				 width: 100%;
				 height: 270px;
				 overflow: auto;
				 display: none;
				 font-size: 12px;
			}
			
			.div-compute-chart {
				 width: 100%;
				 overflow: auto;
				 display: none;
				 margin: 0 auto;
			}
			
			#divintroduction {
				background-color: #f2f2f2;
				font-size: 14px; 
				width: 100%;
				padding: 5px;
			}
			
			.content-wrapper {
				width: 100%;
				text-align: center;
				display: block;
				padding: 5px;
			}
			
			.float-left {
				float: left;
				overflow: auto;
				display: inline-block; 
				text-align: left;
				vertical-align:top;
			}
			
			.float-right {
				float: right;
				display: inline-block; 
				overflow: auto;
				text-align: left;
				vertical-align:top;
			}
			
			.panel-heading a:after {
				font-family:'Glyphicons Halflings';
				content:"\e114";
				float: right;
				color: grey;
			}
			
			.panel-heading a.collapsed:after {
				content:"\e080";
			}
			
			output {
				font-size: 12px;
				padding: 0;
			}

			.page-footer {
				background-color: #EDF0D8;
				padding-top: 10px;
				padding-bottom: 10px;
				display: block;
			}
			
			.img-responsive {
				background: transparent;
			}
			
			.soc-logo span {
				font-weight: 700;
				font-size: 40px;
				line-height: 1;
				margin: 0px;
				padding: 0px;
			}
			
			.brand-soc {
				color: #000;
			}
			
			.brand-app {
				color: #5CB85C;
			}
			
			.cgiar-logo img {
				padding: 23px 10px 0px 0px;
			}
			
			.ciat-logo {
				padding: 23px 10px 0px 0px;
			}
			
			.pull-left {
				float: left !important;
			}
			
			
			
			
			
			
		</style>
	</head>
	
	<body>
	
	
		<!-- Fixed navbar -->
		<nav class="navbar navbar-default navbar-fixed-top">
		  <div class="container-fluid" style="background-color: #000; color: white;">
			<div id="navbar" class="navbar-collapse collapse" style="padding: 5px">
			  <ul class="nav navbar-nav navbar-right">
				<li><a id="aboutlink" href="#" onclick="displayabout()">About</a></li>
				<li><a href="#">Contact Us</a></li>
			  </ul>
			</div>
			
			
			
			<!-- <div class="pull-left">
			<a class="navbar-brand" href="index.html">
				<h1>
					<span class="brand-land-tp">LAND</span>
					<span class="brand-rest">REST</span>
				</h1>
			</a>
            </div>    -->      
			
			
			
			
			
			
		  </div>
		</nav>
		
		<div style="clear:both; height:60px;"></div>
		
		<div id="divintroduction">
			<p>
			There has been quite some debate about the scope for mitigating climate change by soil organic carbon (SOC) sequestration. 
			However, it seems there is a general lack of understanding of quantities and the time-dimension, as well as the possible contribution 
			that SOC-seq. can play. This web application provides a platform where users can visualize the organic carbon content of a soil of 
			their choice, as well as the quantitative impact of soil conserving management practices on sequestration, how such sequestration 
			would unfold over time and what would be the magnitude of SOC seq. if the anticipated practice (to foster SOC seq.) would be scaled 
			out to countries, sub-continents or the entire world. The basis of the idea is the publication from Sommer and Bossio 2014 
			(Dynamics and climate change mitigation potential of soil organic carbon sequestration. J. Environm. Management 144, 83-87.)
			</p>
		</div>
		
		<div class="container-fluid" style="padding: 10px; background-color: #d9d9d9;">
			<div class="form-inline" style="padding-left :10px; padding-right :10px;">
				<div class="form-group">
					<input type="text" class="form-control input-sm" id="txtaddrow" placeholder="No of Layers" style="width:100px">
				</div>
				<div class="form-group">
					<button id="btnaddrow" onclick="addtablerowclick()" class="btn btn-primary btn-sm ladda-button" data-style="expand-left"><span class="ladda-label">Add layers</span></button>
				</div>
				
				<div class="form-group">
					<label for="cmblocality">Locality</label>
					<select id="cmblocality" class="form-control" style="width:170px"></select>
				</div>
				
				<div class="form-group" id="divlocality">
					<input type="text" class="form-control input-sm" id="txtlocality" placeholder="Input Locality" style="width:170px">
				</div>
				
				<div class="form-group">
					<label for="cmblanduse">Land Use</label>
					<select id="cmblanduse" class="form-control" style="width:170px"></select>
				</div>
				
				<div class="form-group" id="divlanduse">
					<input type="text" class="form-control input-sm" id="txtlanduse" placeholder="Input Landuse" style="width:170px">
				</div>
				
				<div class="form-group">
					<input type="text" class="form-control input-sm" id="txtacreage" placeholder="Acreage (Mha)" style="width:120px">
				</div>
				
				<div class="checkbox"><label><input type="checkbox" id="checkcomps" value=""></label></div>
				<button id="btncomputeactivity" onclick="displayactivityvalues()" class="btn btn-success btn-sm ladda-button" data-style="expand-left"><span class="ladda-label">Compute</span></button>
			</div>
		</div>
	
		<div id="divmain" class="container-fluid" style="font-size:12px">
			
			<div class="content-wrapper">
				<div id="divactivity1table" class="float-left" style="width:70%; display: none;">
					<p><h5>User Entries (Input all values):</h5></p>
					<table id="tblactivity1" class="table table-striped table-hover table-bordered table-condensed">
						<thead>
							<th>Layer Thickness (cm)</th><th>SOC conc. (g/kg) - START</th><th>SOC conc. (g/kg) - END</th><th>Bulk density (g/cm3)</th><th>Remove</th>
						</thead>
							
						<tbody>
							
						</tbody>
					</table>
				</div>
				
				<div id="divsocsequence" class="float-right" style="width:25%"></div>
			</div>
			<div style="clear:both; height:10px;"></div>
			
			<div id="outerdiv" class="div-outer">
				<h4>Results</h4>
				<div class="panel-group" id="accordion">
					<div class="panel panel-default">
						<div class="panel-heading">
							<h5 class="panel-title">
							  <a data-toggle="collapse" href="#panel-activity1">SOC Concentration</a>
							</h5>
						</div>
						
						<div id="panel-activity1" class="panel-collapse collapse in" style="padding:10px">
							<div id="divactivity1computedtable" class="div-compute-table"></div>
							<div id="divactivity1graphtable" class="div-compute-table"></div>
							<div id="ct-chartactivity1" class="div-compute-chart" style="width:100% !important; height:100% !important;"></div>
						</div>
					</div>
					
					<div class="panel panel-default">
						<div class="panel-heading">
							<h5 class="panel-title">
							  <a data-toggle="collapse" href="#panel-activity2">SOC Sequestration</a>
							</h5>
						</div>
						
						<div id="panel-activity2" class="panel-collapse collapse in" style="padding:10px">
							<div id="divactivity2computedtable" class="div-compute-table"></div>
							<div id="divactivity2graphtable" class="div-compute-table"></div>
							<div id="ct-chartactivity2" class="div-compute-chart" style="width:100% !important; height:100% !important;"></div>
						</div>
					</div>
					
					<div class="panel panel-default">
						<div class="panel-heading">
							<h5 class="panel-title">
							  <a data-toggle="collapse" href="#panel-activity3">SOC Sequestration Over Time</a>
							</h5>
						</div>
						
						<div id="panel-activity3" class="panel-collapse collapse in" style="padding:10px;">
							<div class="row">
								<div id="divactivity3computedtable" class="col-lg-1 col-md-1 col-sm-1" style="width:35%;"></div>
								<div id="ct-chartactivity3" class="col-lg-2 col-md-2 col-sm-2" style="width:60%;"></div>
							</div>
							<div id="divactivity3graphtable" class="div-compute-table"></div>
						</div>
					</div>
					
					<div class="panel panel-default">
						<div class="panel-heading">
							<h5 class="panel-title">
							  <a data-toggle="collapse" href="#panel-finaltable">Total SOC-Sequestration</a>
							</h5>
						</div>
						
						<div id="panel-finaltable" class="panel-collapse collapse in" style="padding:10px">
							<div id="divtotalsocsequestration" class="div-compute-table">
								<table id="tbltotalsocsequestration" class="table table-striped table-hover table-bordered table-condensed">
									<thead>
										<th>Locality</th><th>Land Use</th><th>Years of seq.</th><th>SOC-sequestration (Mg C)</th>
									</thead>
										
									<tbody>
										
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	
	<footer>
		<div class = "page-footer">
			<div class="container">
				<div class="row">
					<div class="col-md-3">
						<div class="left-footer-details">
							<h1 class="soc-logo">
								<a href="socmain.html">
									<span class="brand-soc">SOC</span>
									<span class="brand-app">APP</span>
								</a>
							</h1>
						</div>
					</div>
					<div class="col-md-5">
						<div class="org-logo-details">
							<p class="ciat-full text-muted">International Center for Tropical Agriculture</p>
							<p class="ciat-full text-muted">Member of the CGIAR Consortium </p>
							<p class="copyright-notice text-muted">© 2015. All Rights Resverved.</p>
						</div>
					</div>
					<div class="col-md-4">
						<div class="org-logo">
							<div class="cgiar-logo pull-left">
								<a href="http://www.cgiar.org/" target="_blank"><img class="img-responsive" src="https://cloud.githubusercontent.com/assets/3735691/11752987/c8ec2efa-a053-11e5-9f09-26ef8b6135e8.png" alt="CIAT"></a>
							</div>
							
							<div class="ciat-logo pull-left">
								<a href="http://ciat.cgiar.org/" target="_blank"><img class="img-responsive" src="https://cloud.githubusercontent.com/assets/3735691/11752964/941fb9bc-a053-11e5-8f7a-00eb1175eeb0.png" alt="CIAT"></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</footer> 
</html>
